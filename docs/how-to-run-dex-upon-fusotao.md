# How To Run a Dex Upon Fusotao

Fusotao Protocol is a verification protocol. This documents will guide you to develop a orderbook based dex upon Fusotao.


## Compile

[Galois](https://github.com/uinb/galois) is a standard matching engine which can be used either as a Fusotao backed dex or a plain cex. This document will only introduce how to use Galois as the Fusotao proving client only.

First, download the recent release version from [Github Release](https:/github.com/uinb/galois/releases). Galois is writen in rust, to compile it, you may need to install [Rustup](https://rustup.rs/) and related toolchain.

```
cargo build --release --all-features
```

## Configurations

The configuration file of Galois looks like below:

```
[server]
# Listening address
bind_addr = "127.0.0.1:8097"

[mysql]
# Mysql server
url = "mysql://username:password@localhost:3306/galois"

[redis]
# We use redis to publish the orderbook, may be deprecated in the future
url = "redis://localhost:6379/0"

[sequence]
# Dump the memory very x events
checkpoint = 100000
# The folder where to save the coredump file and block scanning position
coredump_dir = "/var/galois"
# Batch executing commands
batch_size = 1000
dump_mode = "disk"
# Duration of fetching commands from the mysql
fetch_intervel_ms = 5

[fusotao]
# The Fusotao node rpc address
node_url = "ws://localhost:9944"
# The private key of Sr25519 used for submitting proofs, it can be generated by the `subkey` tool
key_seed = "//Alice"
# Batch submitting proofs, recommend 300
proof_batch_limit = 300
# When register the matcher on-chain
claim_block = 1
# Automatically calculate the transaction fees
fee_adjust_threshold = 1000
enable_from_genesis = true

[log]
[log.appenders.console]
kind = "console"
[log.root]
level = "info"
appenders = ["console"]
[log.loggers.substrate_api_client]
level = "error"

```

## Initialize Dependencies

Galois depends mysql to record all incoming commands including ask/bid/cancel, and trading pair management commands as well. There are 3 groups of mysql table you must create before launching Galois:

- t_sequence (the incoming events, VERY IMPORTANT, CAN NOT BE DELETED OR DROPED)
- t_proof (where to store the proofs, can be re-generated after reboot Galois)
- t_clearing_result_{base}_{quote}_(multi tables divided by the pair code)

Simply import the sql file in the source code folder `sql/init.sql`.

Another dependency is Redis which is used for dump the orderbook(user perspective) periodically, may be deprecated in the future. There is no extra configurations of redis server.

## Encrypt the Configurations

Some of the configurations are sensitive, you may need to encrypt it. Galois provides a simple tool to generate a encrypted config file.

After you fill the config file correctly, simply run the encryption tools:

```
MAGIC_KEY=REPLACE_WITH_YOUR_KEY target/release/enc-config -c galois.toml
```

Now you will get an encrypted configuration file looks like below:

```
[server]
bind_addr = "127.0.0.1:8097"

[sequence]
coredump_dir = "/var/galois"
checkpoint = 100000
batch_size = 1000
dump_mode = "disk"
fetch_intervel_ms = 5
enable_from_genesis = true

[mysql]
url = "kJVQl967ugZL2ngFdFKqhy2R71qwhziKbFOWB5TjWm2AFspJpU6PPGTlo/2+D08P"

[redis]
url = "fuQ/5X23NQN//94tl7wAn9eruMHS9UtWED7fZn2OV1U="

[fusotao]
node_url = "ws://localhost:9944"
key_seed = "IvIDN8Dg9Vo="
claim_block = 1
proof_batch_limit = 300
fee_adjust_threshold = 1000
```

## Launch Galois

To make Galois understand the encrypted information, you need to indicate a same MAGIC_KEY through the environment variable as well when launching Galois.

```
MAGIC_KEY=SAME_KEY_WITH_THE_ENCRYPTION_STEP target/release/galois -c galois.toml
```

Now Galois is waiting for the incoming commands.

## List Pair

There are 2 steps to list a new pair:

1. Execute the mysql command 

```create table t_clearing_result_{base}_{quote} like t_clearing_result;```

to create a new table.

*NOTICE*: the base and quote are not inner codes but legal token code on Fusotao chain, e.g. 

0 -> $TAO (fusotao-token.near)    
1 -> $USDT (dac17f958d2ee523a2206206994597c13d831ec7.factory.bridge.near).

All the token codes must refer to a valid token contract deployed NEAR. Before the token can be traded on Fusotao, it must be registered in the trustless [Octopus Bridge](https://mainnet.oct.network/bridge/near/fusotao/). The registering itself is also permissionless, but must be executed by the Ocotopus Network operator mannually at present. 

2. Insert a command into the `t_sequence`

```insert into t_sequence(f_cmd) values('{"base":0,"quote":1,"base_scale":2,"quote_scale":4,"taker_fee":"0.002","maker_fee":"0.002","min_amount":"0.1","min_vol":"10","enable_market_order":false,"open":true,"cmd":13}');```

For more details of the commands, please refer to the [README](https://github.com/uinb/galois).

## Register DEX

To be an validated dex, the address must be registered on the Fusotao chain.

In the #Configurations section, we indicated the `key_seed` field which can be generated by the subkey tool which is published by the Substrate team. E.g.

```
$subkey generate
Secret phrase:       income repair trouble apart work memory divorce famous short vintage device virus
  Network ID:        substrate
  Secret seed:       0x8e51362c8a14f9183b5a33d26cd0bd39931c78ff7ca73c1d7ab76722d11b487c
  Public key (hex):  0xaea8cab5dfbb3b8c24ecc15d6abfbb1e9387565747078d36fd2da37c5b148201
  Account ID:        0xaea8cab5dfbb3b8c24ecc15d6abfbb1e9387565747078d36fd2da37c5b148201
  Public key (SS58): 5G1iL8tcFL7h3F9W8uvEDWq5zRvjrjDk2ymFJUjxMgZ3CNZp
  SS58 Address:      5G1iL8tcFL7h3F9W8uvEDWq5zRvjrjDk2ymFJUjxMgZ3CNZp
```

Import the menomnic phrase into Polkadotjs wallet, then go to [Fusotao Mainnet RPC Endpoint](https://polkadot.js.org/apps/?rpc=wss://gateway.mainnet.octopus.network/fusotao/0efwa9v0crdx4dg3uj8jdmc5y7dj4ir2#/explorer) and submit the register transaction(make sure the address has own some $TAO to pay gas fee). While testnet rpc endpoint is [Fusotao Testnet RPC Endpoint](https://polkadot.js.org/apps/?rpc=wss%3A%2F%2Fgateway.testnet.octopus.network%2Ffusotao%2Ferc8ygm5qvmi2fw23ijpvzgpzzto47mi#/extrinsics).

In the page, select `verifier`, `register`, and input the dex's name you like, then submit the transaction.

![](/wiki/register-dex.png)

The final step of registering is make PR to our [Github Repo](https://github.com/uinb/fusotao-registry) where to save dex's name, logo and url:

```
{
  "fxdx": {
    "name": "fxdx",
    "website": "https://testnet.fxdx.finance",
    "address": "5GxCNDyhqv2hx2zcQfse58vLWcueJKMjXPTgzcJbi9khtNrf",
    "logo": "https://testnet.fxdx.finance/fxdx.png"
  }
  // add your information here
}
```

## Where Are The Tokens From


Different from CEXs, the trading platforms backed by Fusotao couldn't hold users' assets, instead, users use the `Authorize` and `Revoke` transactions to deposit and withdraw. After the Galois launched and registered, users can submit a `Authorize` transaction to authorize some tokens to a DEX which will issue a receipt on chain. If everything goes well, the Galois will automatically execute a `TRANSFER_IN` command and submit the proof back to remove the receipt. So does the `Revoke` transaction.

To test the procedures, you can submit the transactions on the testnet endpoint.

![](/wiki/authorize-dex.png)

In the page, select `verifier`, `authorize`, input the target dex's address and token id and amount, then submit the transaction.

In the real product, you may need to integrate with the [Avatar Wallet Extension](https://github.com/uinb/avatar-wallet)([Install from Chrome](https://chrome.google.com/webstore/detail/avatar-wallet/ckfhnogibicdkfkijinnacpmmobbhbjk)) in your webpage to enable users to sign the transaction.
