# Prover (Out-of-date)

This section will introduce how to use Galois as a Fusotao proving client.

## Compiling Galois

Same as compiling Fusotao node, [Rustup](https://rustup.rs/) is essential. After rustup is installed, download the recent release from [Galois Release](https:/github.com/uinb/galois/releases) and compile it in release mode with all features enabled:

```
cargo build --release --all-features
```

## Configurations

The configuration file of Galois looks like below, simply copy it and modify later:

```
[server]
# Listening address
bind_addr = "127.0.0.1:8097"

[mysql]
# Mysql server
url = "mysql://username:password@localhost:3306/galois"

[redis]
# Galois uses redis to publish the orderbook. This might be deprecated in the future
url = "redis://localhost:6379/0"

[sequence]
# Dump the memory very x events
checkpoint = 100000
# The folder where to save the coredump file and block scanning position
coredump_dir = "/var/galois"
# Batch executing commands
batch_size = 1000
dump_mode = "disk"
# Duration of fetching commands from the mysql
fetch_intervel_ms = 5

[fusotao]
# The Fusotao node rpc address
node_url = "ws://localhost:9944"
# The private key of Sr25519 used for submitting proofs, it can be generated by the `subkey` tool
key_seed = "//Alice"
# Batch submitting proofs, recommend 300
proof_batch_limit = 300
# When register the matcher on-chain
claim_block = 1
enable_from_genesis = true
# need to setup the associated pubkey on chain
x25519_priv = "0x8e51362c8a14f9183b5a33d26cd0bd39931c78ff7ca73c1d7ab76722d11b487c"

```

## Initializing dependencies

Galois depends on mysql to record all user commands including ask/bid/cancel, as well as the trading pair management commands. There are 3 groups of mysql table you must create before launching Galois:

- t_sequence (the incoming events, VERY IMPORTANT, CAN NOT BE DELETED OR DROPED)
- t_proof (where to store the proofs, can be re-generated after Galois reboot)
- t_clearing_result_{base}_{quote} (replace the place holder with the real currency codes)

All the essential sql table schemas have been included in the file `sql/init.sql`, simply importing it is ok.
Another dependency is Redis which is used for dumping the orderbook(user perspective) periodically. It might be deprecated in the future.

## Encrypting the file

Some of the configurations are sensitive, you may need to encrypt it. Galois provides a simple tool to generate a encrypted config file.

After filling the config file correctly, simply run the encryption tools:

```
MAGIC_KEY=REPLACE_WITH_YOUR_KEY target/release/galois -c galois.toml encrypt-config
```

Now you will get an encrypted configuration file looks like below:

```
[server]
bind_addr = "127.0.0.1:8097"

[sequence]
coredump_dir = "/var/galois"
checkpoint = 100000
batch_size = 1000
dump_mode = "disk"
fetch_intervel_ms = 5
enable_from_genesis = true

[mysql]
url = "kJVQl967ugZL2ngFdFKqhy2R71qwhziKbFOWB5TjWm2AFspJpU6PPGTlo/2+D08P"

[redis]
url = "fuQ/5X23NQN//94tl7wAn9eruMHS9UtWED7fZn2OV1U="

[fusotao]
node_url = "ws://localhost:9944"
key_seed = "IvIDN8Dg9Vo="
claim_block = 1
proof_batch_limit = 300
x25519_priv = "H4sIAKj/J2QAA8suTslKyylOyU5LKU4rTkkr5gIAHgi+IhIAAAA="
```

## Launching Galois

To make Galois understand the encrypted information, you need to indicate a same MAGIC_KEY through the environment:

```
MAGIC_KEY=SAME_KEY_WITH_THE_ENCRYPTION_STEP target/release/galois -c galois.toml
```

Now Galois is waiting for the incoming commands.

## Registering the prover

In the [Configurations](#Configurations) section, we have filled the `key_seed` with the well-known `Alice`. Beyond the test, we should generate a real private key and register the address on Fusotao chain to enable submitting proofs.    
The easiest way to generate a private key is to use the [subkey](https://github.com/paritytech/subkey) tool developed by the Parity team:

```
$subkey generate
Secret phrase:       income repair trouble apart work memory divorce famous short vintage device virus
  Network ID:        substrate
  Secret seed:       0x8e51362c8a14f9183b5a33d26cd0bd39931c78ff7ca73c1d7ab76722d11b487c
  Public key (hex):  0xaea8cab5dfbb3b8c24ecc15d6abfbb1e9387565747078d36fd2da37c5b148201
  Account ID:        0xaea8cab5dfbb3b8c24ecc15d6abfbb1e9387565747078d36fd2da37c5b148201
  Public key (SS58): 5G1iL8tcFL7h3F9W8uvEDWq5zRvjrjDk2ymFJUjxMgZ3CNZp
  SS58 Address:      5G1iL8tcFL7h3F9W8uvEDWq5zRvjrjDk2ymFJUjxMgZ3CNZp
```

The registry procedure is an on-chain transaction. To submit the extrinsic, you need some $TAO tokens in your address to pay the gas fees. If you are testing Galois and already installed a Fusotao node, simply transfer some from the endowed accounts, otherwise, contact the Fusotao team for help.
Then, import the menomnic phrase into Polkadotjs or Avatar wallet and submit the extrinsic on [Fusotao Mainnet RPC Endpoint](https://polkadot.js.org/apps/?rpc=wss://gateway.mainnet.octopus.network/fusotao/0efwa9v0crdx4dg3uj8jdmc5y7dj4ir2#/explorer)(Click the left upper corner to switch to your local node if you are testing).
In the page, select `verifier`, `register`, and input the dex's name you like, then click 'Submit Extrinsic'.

The final step of registering a DEX is to make a PR to our [Github Repo](https://github.com/uinb/fusotao-registry) where to save dex's name, logo and url:

```
{
  "fxdx": {
    "name": "fxdx",
    "website": "https://testnet.fxdx.finance",
    "address": "5GxCNDyhqv2hx2zcQfse58vLWcueJKMjXPTgzcJbi9khtNrf",status
    "logo": "https://testnet.fxdx.finance/fxdx.png"
  }
  // add your information here
}
```


## Testing authorizing and revoking

Different from CEXs, the trading platforms upon Fusotao don't hold any users' assets, instead, users shall use the `Authorize` and `Revoke` transactions to deposit and withdraw. After a prover registered, users can submit a `Authorize` transaction to authorize some tokens to it and that will issue a receipt on chain. If everything goes well, the prover will automatically execute a `TRANSFER_IN` command and submit the associated proof back to remove the receipt. The `Revoke` transaction is the similar procedure.


## Listing pairs

Fusotao chain doesn't support any smart contract right now. All the tokens are from other chains and must be registered on the bridges.    
Currently, Fusotao support 3 kinds of foreign tokens:
- NEP141 (OctopusBridge maintained by the Octopus Team)
- ERC20 (ChainBridge maintained by the Fusotao Team)
- BEP20 (ChainBridge maintained by the Fusotao Team)

Before listing tokens, DEX operator must submit the token information on the #[page](#) since the registration must be setup on the both sides.
If the token already registered, the remain steps are quite simple:

1. Execute the mysql command 

```create table t_clearing_result_{base}_{quote} like t_clearing_result;```

to create a new table.

*NOTICE*: the base and quote are not inner codes but legal token code on Fusotao chain. See #[Assets](#Assets).

2. Insert the openning command into the `t_sequence`


```insert into t_sequence(f_cmd) values('{"base":0,"quote":1,"base_scale":2,"quote_scale":4,"taker_fee":"0.002","maker_fee":"0.002","min_amount":"0.1","min_vol":"10","enable_market_order":false,"open":true,"cmd":13}');```

For more details of the commands, please refer to the [README](https://github.com/uinb/galois).

